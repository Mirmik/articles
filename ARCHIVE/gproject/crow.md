#Протокол передачи данных crow.

##Summary.

Crow - сетевой протокол передачи данных в многоранговой сети. В отличии от протокола ip, где отправитель определяет концевые точки передачи-приёма, пакет crow содержит полную информацию о том, куда и через какие узлы его следует передать.

С одной стороны это требует от отправителя понимания топологии сети, а с другой позволяет существенно понизить требования к инфраструктуре, что позволяет использовать протокол на слабых вычислителях с широким выбором канальных уровней.

Узлы сети носят название tower и связанны между собой с помощью имплементаций сущности gateway. Пакет перемещаясь по сети, проходит от одного gateway к другому, перенаправляясь согласно маршруту, заданному во фрейме адресса.

Gateway протокола абстрактен и может работать с любыми каналами связи, обеспечивая передачу через канальные и датаграмные соединения, на уровнях osi от канального до транспортного: usart, i2c, udp, tcp, tor-hidden-service, радиосвязь, и, впринципе, через любую физическую и програмную сущность, способную переправить датаграмму из точки A в точку B. 

Концевые точки осуществляют поддержку качества обслуживания пакетов на основе ack фреймов. Поддерживается три типа качества обслуживания - без подтверждения (доставка пакета максимум один раз), с подтверждением получения (доставка пакета не менее одного раза), с двойным подтверждением (доставка пакета один раз).

Многоранговая природа сети приводит к усложнению фрейма адреса. Для записи адресов в удобочитаемой человеком форме, разработана специальная нотация.

Префексы:
. - один байт в десятичной форме.
: - два байта в десятичной форме.
\# - шестнадцатеричные данные в ascii кодировке.
@ - Текстовые данные. Символ '\' используется для экранирования символов префексов. 

Пример записи адреса:
.04.10#0A.12.127.0.0.1:10009.14@chrewekui\.onion:1789.12.192.168.1.213:6789 

В зависимости от топологии сети и кодов врат(gateway), эта запись может означать различные вещи.
Например, прочтение может быть таким.
.04.10 - передать пакет по i2c (.04) устройству с адресом 10(.10).
\#0A - отправить пакет по usart (#0A).
.12.127.0.0.1:10009 - использовать udp (.12) для передачи на localhost (.127.0.0.1) порт 10009 (:10009).
.14@chrewekui.onion:17089 - переслать на tor-hidden-service chrewekui.onion порт 17089.
.12.192.168.1.213:6789  - переслать в локальной сети на адрес 6789

Как видно из этого примера, пакет может проходить довольно длинный сложный путь, но отправитель должен четко представлять структуру сети gateway, чтобы пакет попал к получателю. Протокол принципиально не терпит горячей смены топологии сети (если это, конечно не решится на уровне отдельного канала. Например, если в качестве канала используется tcp соединение).

##Расширения. 
###Nodes (код G1_G0TYPE)

Расширение реализует пространство портов на базе tower сети. Это достигается добавлением специального подзаголовка с id передающего и приёмного узла(node).

Если пакет маркирован кодом G1_G0TYPE, система считывает целевой узел, и, если тот зарегестрирован, передает ему пакет. Узел назначает свой обработчик для пакета.

Протокол определяет специальные типы узлов - канал(channel) и ацептор(acceptor) для реализации передачи данных с установлениям соединения. В данном режиме контролируется порядок поступающих пакетов.

###Publisher-subscriber (код G1_G3TYPE)
Данное расширение реализует примитивы для работы с брокером сообщений (технически брокер может выходить за рамки протокола crow, потому). 