# ZenCad 1.0.0

С прошлой публикации по теме прошло уже более года и теперь я наконец-то могу сообщить, что система скриптового моделирования ZenCad доросла до версии 1.0.0.

Переход на версию 1.0.0 означает, что мы наконец-то достаточно стабильны, чтобы я не краснеть и достаточно уверены в API, чтобы не рушить каждую пятницу обратную совместимость.

Предыдущие материалы по теме:

## Что такое ZenCad:

ZenCad - python-библиотека 3д моделирования, основанная на синтаксисе и общей коцепции системы openscad и геометрическом ядре opencascade. Вместе с библиотекой поставляется одноимённое приложение, позволяющее разрабатывать 3д модели в стиле openscad. 

Разработка в zencad - это скриптовое 3д моделирование. Такая разработка отличается от построения 3д графики в интерактивных графических средах. Если в графическом интерфейсе модель строится, с применением инструментов в графическом поле, то при скриптовом подходе вместо этого порядок применения инструментов прописывается в код программы, которая, в процессе своего выполнения создаёт 3д модель. Средствами zencad такая модель также может быть отрисована и анимирована.

Интеграция в экосистему python позволяет использовать при построении модели и работе с анимацией всевозможные наборы входных данных, отображать результаты расчетов и при использовании анимации, визуализировать результаты моделирования движения и полунатурных испытаний.

## Инструментарий ZenCad.
Основа ZenCad - CSG инстументарий. То есть, тела строятся на основе более простых тел с применением булевых операций. В качестве составных частей могут использоваться тела примитивы или же объекты выведенные из выполнением функций над прочими трёхмерными, двумерными или одномерными объектами. 


Ознакомится с перечнем примитивов и операций можно в [документации].

## Ленификация и функциональное программирование.
Расчет геометрии в ZenCad строго функциональный. Тела в zencad иммутабельны, применение функций и методов не изменяет их, но строит новые на основе входных аргументов, то есть тела выводятся как результат вычисления некой чистой функции. Такой подход позволяет развернутся ленивым вычислениям. ZenCad хранит на жестком диске промежуточные результаты вычислений и по мере возможности подгружает их вместо непосредственного расчёта, что позволяет достаточно серьёзно (в десятки и сотни раз) сократить время выполнения скриптов.

## Отображения и анимация.
Для отображения результатов вычислений ZenCad оперирует интерактивными объектами, которые могут быть сконструированы на основе полученной геометрии или быть созданы непосредственно.

Сцена не статична, интерактивные объекты можно перемещать, тем самым реализуя анимированное театральное представление. 

## Сборки и кинематика.
Для облегчения рисование сложных сцен, содержащих множество совместно движущихся, перемещающихся относительно друг другу интерактивных объектов, zencad предоставляет механизм сборочных единиц (сборочный юнит).

Сборочный юнит (zencad.assemble.unit) - это контейнер в который может быть помещена коллекция совместно расположенных интерактивных объектов и сборочных юнитов. Сборочный юнит может иметь родителя, который задаёт для него и его объектов локальную систему координат, и локальное положение в системе родителя. Иерархия юнитов, в которой один юнит ссылается на второй, тот на третий и так далее, задаёт композицию преобразований расположения интерактивных объектов.

Эта концепция, состоящая всего из двух пунктов, композиция и иерархия, оказывается достаточно мощной, чтобы строить системы со сложным поведением. Например, если базовым юнитом является тело робота, а голова и руки зависимыми, то перемещая базовый юнит, мы будем перемещать всё тело робота целиком, а изменяя локальное положение зависимых юнитов, шевелить головой и руками. При этом голова может быть представлена несколькими интерактивными объектами и на ней можно расположить юниты ушей, чтобы ушами можно было независимо покрутить.

[Разметка посадочных мест под крепёж.]

## ZenCad - это не только ценный мех.
Библиотека получилась довольно гибкой и доступной к расширенюю.

## Модель вычислений в основном приложении. 
В первых версиях zencad графический интерфейс приложения выполнял вычисления в отдельном потоке того же интерпретатора. Это была довольно простая модель, но она, увы, не являлась достаточно чистой в том плане, что загружаемые модули оставались в пространстве интерпретатора, а крах скрипта мог привести к краху всей программы. 

С тех пор концепция довольно сильно изменилась, многопоточная модель была заменена моделью многопроцессной с использованием механизма оконного встраивания и пайпами для передачи сообщений между процессами. Теперь выполняемые скрипты живут в независимом адресном пространстве и не рушат gui при сегфолтах или прочих критических ситуациях.

Приложение умеет отслеживать изменения в исполняемом файле и в случае, если таковые были обнаружены, запускает перерасчет модели в новом процессе. Такое поведение позволяет естественным образом видеть изменение модели по мере разработки. 

## Поддержка операционных систем и установка.
На текущий момент zencad запускается на debian, windows, osx. Debian - основная платформа, на windows и osx проект может в силу недостаточного тестирования работать не так стабильно. 

Основной способ дистрибуции zencad - установка через pypi.
```python
python -m pip install zencad
``` 

Также для виндоюзеров, где терминал не столь общепринят, доступна standalone версия.

zencad тянет с собой бинарную сборку, именуемую pyservoce, которая в пакетной версии поставляется с набором динамических библиотек геометрического ядра и сопутствующих инструментов. Установка из исходного кода потребует предварительной сборки (или установки из сторонних источников) соответствующих библиотек. Инструкции по установке соответствующих библиотек доступны на страницах их проектов.

## Быстрый старт.
Чтобы посмотреть на систему вблизи будет достаточно установить её из пакетного менеджера и выполнить команду запуска приложения.
```sh
# Установка:
python3 -m pip install zencad

# Запуск:
zencad
# или
python3 -m zencad
```

Альтернативный способ - запуск скрипта на исполнение из консоли. Например:
```python
# testscript.py
```

```sh
python3 ./testscript.py
```

## О текущем состоянии дел.
Хотя zencad еще только-только дорос до более-менее стабильного состояния, судя по всему, система своего пользователя получила. Если помониторить интернет, можно найти некоторое количество выложенных в открытый доступ моделей и нет-нет, да обсуждения на форумах.

На гитхабе в репозиторий проекта, как показывает статистика посещения, тоже постоянно кто-то заглядывает и читает мануал.

Хочу выразить свою благодарность всем тем замечательным людям, что слали сообщения о багах, неочевидных местах API, указывали на места, которые можно было улучшить и дополнить, или же присылали пулреквесты в код проекта. Все эти замечательные имена сохранены в памяти гитхаба в issue и комитах, а также в коментариях к статьям хабра. Благодаря обратной связи удалось, как мне кажется, довести API и мануал до интуитивно понятного состояния, а также отладить систему поставки новых версий.

К сожалению, не всё, что планировалось было реализовано. Много было разговоров о поддержке экспорта и импорта форматов, а воз и ныне там, где и был. Думаю, это будет точкой приложения силы в ближайшем будущем.

К большому моему сожалению, процесная модель вычислений оказалось плохо совместимой с отображением графики во встроенном виджете в OSX. На OSX встраивание работает как-то по другому и я пока не умею это поправить. По этой причине в OSX виджет с моделью болтается вне окна самой программы. Это вдвойне обидно, поскольку одно из первых сообщений, что я получил в качестве фидбека состояло в том, что zencad запустился на маке. 

## О планах на будущее.




## Ссылки на ресурсы:



P.S. Отдельное спасибо камраду Олегу Медовикову (@https://habr.com/ru/conversations/olegka_medovikov/) за предоставленные скриншоты и видеозаписи его работ в оформлении настоящей статьи.